


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://insper.github.io/Embarcados-Avancados/Tutorial-FPGA-NIOS-IP/">
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.11">
    
    
      
        <title>Tutorial 3 - FPGA - IP - Eletiva: Embarcados Avançados (SoC e Linux Embarcado)</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.860688db.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.943997b5.min.css">
      
      
        
        
        <meta name="theme-color" content="#ffffff">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/progress.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="pink">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tutorial-3-fpga-ip" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://insper.github.io/Embarcados-Avancados/" title="Eletiva: Embarcados Avançados (SoC e Linux Embarcado)" class="md-header-nav__button md-logo" aria-label="Eletiva: Embarcados Avançados (SoC e Linux Embarcado)">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Eletiva: Embarcados Avançados (SoC e Linux Embarcado)
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Tutorial 3 - FPGA - IP
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/insper/Embarcados-Avancados/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Insper/Embarcados-Avancados
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://insper.github.io/Embarcados-Avancados/" title="Eletiva: Embarcados Avançados (SoC e Linux Embarcado)" class="md-nav__button md-logo" aria-label="Eletiva: Embarcados Avançados (SoC e Linux Embarcado)">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Eletiva: Embarcados Avançados (SoC e Linux Embarcado)
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/insper/Embarcados-Avancados/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Insper/Embarcados-Avancados
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Projeto
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Projeto" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Projeto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Projeto-Overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Projeto-Rubrica/" title="Rubrica" class="md-nav__link">
      Rubrica
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Projeto-Entrega-1/" title="Entregas" class="md-nav__link">
      Entregas
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      FPGA
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="FPGA" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-FPGA-RTL/" title="Tutorial 1 - FPGA - RTL" class="md-nav__link">
      Tutorial 1 - FPGA - RTL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Entrega-1/" title="👁 Entrega 1" class="md-nav__link">
      👁 Entrega 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-FPGA-NIOS/" title="Tutorial 2 - FPGA - NIOS" class="md-nav__link">
      Tutorial 2 - FPGA - NIOS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Entrega-2/" title="👁 Entrega 2" class="md-nav__link">
      👁 Entrega 2
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Tutorial 3 - FPGA - IP
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="Tutorial 3 - FPGA - IP" class="md-nav__link md-nav__link--active">
      Tutorial 3 - FPGA - IP
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#comecando" class="md-nav__link">
    Começando
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ip-cores" class="md-nav__link">
    IP Cores
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#platform-desginer" class="md-nav__link">
    Platform Desginer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#barramentos" class="md-nav__link">
    Barramentos
  </a>
  
    <nav class="md-nav" aria-label="Barramentos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#avalon" class="md-nav__link">
    Avalon
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#projeto" class="md-nav__link">
    Projeto
  </a>
  
    <nav class="md-nav" aria-label="Projeto">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#criando-um-periferico" class="md-nav__link">
    Criando um periférico
  </a>
  
    <nav class="md-nav" aria-label="Criando um periférico">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#avalon-slave-memory-mapped" class="md-nav__link">
    Avalon Slave Memory Mapped
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#especificacao" class="md-nav__link">
    Especificação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gerar-hdl-que-representa-o-periferico-com-interface-avalon" class="md-nav__link">
    Gerar HDL que representa o periférico com interface Avalon
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configurando-path" class="md-nav__link">
    Configurando path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#criando-componente" class="md-nav__link">
    Criando componente
  </a>
  
    <nav class="md-nav" aria-label="Criando componente">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files" class="md-nav__link">
    Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#signals-interfaces" class="md-nav__link">
    Signals &amp; Interfaces
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finalizando" class="md-nav__link">
    Finalizando
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilizando-o-componente-no-pd" class="md-nav__link">
    Utilizando o componente no PD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilizando-o-componente-no-toplevelvhd" class="md-nav__link">
    Utilizando o componente no topLevel.vhd
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firmware" class="md-nav__link">
    Firmware
  </a>
  
    <nav class="md-nav" aria-label="Firmware">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#executando" class="md-nav__link">
    Executando
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulando" class="md-nav__link">
    Simulando
  </a>
  
    <nav class="md-nav" aria-label="Simulando">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configurando-o-bsp" class="md-nav__link">
    Configurando o bsp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelsim" class="md-nav__link">
    ModelSim
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entrega-3" class="md-nav__link">
    Entrega 3
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Entrega-3/" title="👁 Entrega 3" class="md-nav__link">
      👁 Entrega 3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      HPS
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="HPS" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        HPS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-HPS/" title="Visão geral" class="md-nav__link">
      Visão geral
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-HPS-Running/" title="Tutorial 4 - HPS - Linux embarcado" class="md-nav__link">
      Tutorial 4 - HPS - Linux embarcado
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-HPS-BuildSystem/" title="Tutorial 5 - HPS - Infra" class="md-nav__link">
      Tutorial 5 - HPS - Infra
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-HPS-BlinkLED/" title="Tutorial 6 - HPS - BlinkLED" class="md-nav__link">
      Tutorial 6 - HPS - BlinkLED
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Entrega-4/" title="👁 Entrega 4" class="md-nav__link">
      👁 Entrega 4
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-HPS-Kernel/" title="Tutorial 7 - HPS - Compilando o kernel" class="md-nav__link">
      Tutorial 7 - HPS - Compilando o kernel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-HPS-Buildroot/" title="Tutorial 8 - HPS -Buildroot" class="md-nav__link">
      Tutorial 8 - HPS -Buildroot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Entrega-5/" title="👁 Entrega 5" class="md-nav__link">
      👁 Entrega 5
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      HPS + FPGA
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="HPS + FPGA" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        HPS + FPGA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-HPS-FPGA-BlinkLED/" title="Tutorial - HPS + FPGA - Blink LED" class="md-nav__link">
      Tutorial - HPS + FPGA - Blink LED
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-HPS-FPGA-VGA/" title="Tutorial - HPS + FPGA - VGA" class="md-nav__link">
      Tutorial - HPS + FPGA - VGA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Entrega-6/" title="👁 Entrega 6" class="md-nav__link">
      👁 Entrega 6
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Entrega-Extra-1/" title="👁 Entrega Opcional 1" class="md-nav__link">
      👁 Entrega Opcional 1
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Acelerando
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Acelerando" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Acelerando
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Tutorial-Acelerando-HLS/" title="Tutorial - Acelerando - HLS" class="md-nav__link">
      Tutorial - Acelerando - HLS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Úteis
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Úteis" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon"></span>
        Úteis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../info-FPGA-e-Softwares/" title="Infraestrutura de HW e SWs" class="md-nav__link">
      Infraestrutura de HW e SWs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../info-VHDL/" title="VHDL" class="md-nav__link">
      VHDL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../info-SDcard/" title="Atualizando o SDCARD" class="md-nav__link">
      Atualizando o SDCARD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../info-HPS-Serial/" title="Screen" class="md-nav__link">
      Screen
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../info-HPS-ethernet/" title="Ethernet" class="md-nav__link">
      Ethernet
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Tutoriais Alunos
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Tutoriais Alunos" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon"></span>
        Tutoriais Alunos
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../2019/Tutoriais/" title="Tutoriais 2019" class="md-nav__link">
      Tutoriais 2019
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../2019/Gabriel-TensorFlow/" title="Gabriel Moreira - TensorFlow" class="md-nav__link">
      Gabriel Moreira - TensorFlow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../2019/Leo-OpenCL/" title="Leonardo Medeiros - Tutorial OpenCL" class="md-nav__link">
      Leonardo Medeiros  - Tutorial OpenCL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../2019/Elisa-Yocto/" title="Elisa Malzoni - Yocto" class="md-nav__link">
      Elisa Malzoni - Yocto
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../2019/Pedro-OpenCV/" title="Pedro de la Penã - Jetson Nano GPU" class="md-nav__link">
      Pedro de la Penã - Jetson Nano GPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../2019/Martim-F1/" title="Martim F. José - FPGA na AWS" class="md-nav__link">
      Martim F. José - FPGA na AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../2019/Toranja-DevDriver/" title="Bruno Toranja - Linux Device Driver" class="md-nav__link">
      Bruno Toranja - Linux Device Driver
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#comecando" class="md-nav__link">
    Começando
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ip-cores" class="md-nav__link">
    IP Cores
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#platform-desginer" class="md-nav__link">
    Platform Desginer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#barramentos" class="md-nav__link">
    Barramentos
  </a>
  
    <nav class="md-nav" aria-label="Barramentos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#avalon" class="md-nav__link">
    Avalon
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#projeto" class="md-nav__link">
    Projeto
  </a>
  
    <nav class="md-nav" aria-label="Projeto">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#criando-um-periferico" class="md-nav__link">
    Criando um periférico
  </a>
  
    <nav class="md-nav" aria-label="Criando um periférico">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#avalon-slave-memory-mapped" class="md-nav__link">
    Avalon Slave Memory Mapped
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#especificacao" class="md-nav__link">
    Especificação
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gerar-hdl-que-representa-o-periferico-com-interface-avalon" class="md-nav__link">
    Gerar HDL que representa o periférico com interface Avalon
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configurando-path" class="md-nav__link">
    Configurando path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#criando-componente" class="md-nav__link">
    Criando componente
  </a>
  
    <nav class="md-nav" aria-label="Criando componente">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files" class="md-nav__link">
    Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#signals-interfaces" class="md-nav__link">
    Signals &amp; Interfaces
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finalizando" class="md-nav__link">
    Finalizando
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilizando-o-componente-no-pd" class="md-nav__link">
    Utilizando o componente no PD
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#utilizando-o-componente-no-toplevelvhd" class="md-nav__link">
    Utilizando o componente no topLevel.vhd
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firmware" class="md-nav__link">
    Firmware
  </a>
  
    <nav class="md-nav" aria-label="Firmware">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#executando" class="md-nav__link">
    Executando
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulando" class="md-nav__link">
    Simulando
  </a>
  
    <nav class="md-nav" aria-label="Simulando">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configurando-o-bsp" class="md-nav__link">
    Configurando o bsp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modelsim" class="md-nav__link">
    ModelSim
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entrega-3" class="md-nav__link">
    Entrega 3
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Insper/Embarcados-Avancados/edit/master/docs-src/Tutorial-FPGA-NIOS-IP.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="tutorial-3-fpga-ip">Tutorial 3 - FPGA - IP<a class="headerlink" href="#tutorial-3-fpga-ip" title="Permanent link">&para;</a></h1>
<div class="admonition success">
<p class="admonition-title">Revisão 2020-2</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> quartus 20.01</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> teoria/ texto</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled/><span class="task-list-indicator"></span></label> passos validados </li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> spellcheck</li>
</ul>
<p>Melhorar especificação de componente (mapa de registradores?)</p>
</div>
<p>Nesse tutorial deseja-se desenvolver um periférico customizado para o processador NIOS, esse periférico será dedicado ao controle dos LEDs da placa, o periférico terá um banco de registradores interno para seu controle, e interface de "I/O mapeado em memória".</p>
<h2 id="comecando">Começando<a class="headerlink" href="#comecando" title="Permanent link">&para;</a></h2>
<p>Para seguir esse tutorial, é necessário:</p>
<ul>
<li><strong>Hardware:</strong> DE10-Standard e acessórios </li>
<li><strong>Softwares:</strong> Quartus 18.01 <ul>
<li>Modelsim Simulator</li>
</ul>
</li>
</ul>
<p>Entrega no git:</p>
<ul>
<li><strong>Pasta:</strong> <code>Lab3_FPGA_IP/</code></li>
</ul>
<h2 id="ip-cores">IP Cores<a class="headerlink" href="#ip-cores" title="Permanent link">&para;</a></h2>
<p>Intelectual Proprety Core (<a href="https://www.xilinx.com/support/documentation/sw_manuals/xilinx11/cgn_c_ip_overview.htm">IP Core</a>) são componentes descritos em HDL que possibilitam ser utilizados em múltiplos projetos de Hardware. O Platform Designer (PD) fornece além da interface visual de conexão um padrão de comunicação entre os componentes, facilitando assim o uso desses IPs.</p>
<p>Além das centenas de projetos espalhados pela internet (github), existe um repositório muito completo de IP cores opensource que concentra grande variedade de projeto:</p>
<ul>
<li><a href="http://opencores.org/projects">opencores</a></li>
</ul>
<p>As empresas também disponibilizando IPs, pagos e gratuitos:</p>
<ul>
<li><a href="https://www.altera.com/products/intellectual-property/ip.html">Intel-FPGA IP cores</a></li>
</ul>
<h2 id="platform-desginer">Platform Desginer<a class="headerlink" href="#platform-desginer" title="Permanent link">&para;</a></h2>
<p>O PD é uma ferramenta integradora de IPs, com ela é muito simples inserirmos e criarmos componentes que serão utilizados para formar um sistema mais completo. Como no caso do tutorial passado onde usamos uma série de componentes para criar nosso projeto. Esses componentes são de certa forma IPs (simples como o PIO e complexo como o NIOS).</p>
<p>A integração dos IPs no PD se da devido à padronização da comunicação entre esses componentes, que é dada via o barramento.</p>
<h2 id="barramentos">Barramentos<a class="headerlink" href="#barramentos" title="Permanent link">&para;</a></h2>
<p>A Intel-FPGA define duas categorias de barramento de dados para o PD: <strong>Avalon</strong> e <strong>AXI</strong>. O barramento Avalon é a principal maneira de conectar um periférico ao NIOS (processador), já o AXI é o padrão de barramento do ARM, que também é utilizado no platform designer.</p>
<h3 id="avalon">Avalon<a class="headerlink" href="#avalon" title="Permanent link">&para;</a></h3>
<p>Documentação completa dos tipos do barramento AVALON:</p>
<ul>
<li><a href="https://www.intel.com/content/dam/www/programmable/us/en/pdfs/literature/manual/mnl_avalon_spec.pdf">https://www.intel.com/content/dam/www/programmable/us/en/pdfs/literature/manual/mnl_avalon_spec.pdf</a></li>
</ul>
<p>O barramento Avalon define basicamente dois tipos de comunicação: <strong>Memory Mapped (MM)</strong> e <strong>Avalon Streaming Interface (ST)</strong>, conforme descrição a seguir extraído da documentação:</p>
<ul>
<li><strong>Avalon Streaming Interface (Avalon-ST)</strong> — an interface that supports the unidirectional flow of data, including multiplexed streams, packets, and DSP data.</li>
<li><strong>Avalon Memory Mapped Interface (Avalon-MM)</strong> — an address-based read/write interface typical of master–slave connections.</li>
<li>Avalon Conduit Interfae — an interface type that accommodates individual signals or groups of signals that do not fit into any of the other Avalon types. You can connect conduit interfaces inside a Platform Designer system. Or, you can export them to make connections to other modules in the design or to FPGA pins.</li>
<li>Avalon Tri-State Conduit Interface (an interface to support connections to off-chip peripherals. Multiple peripherals can share pins through signal multiplexing, reducing the pin count of the FPGA and the number of traces on the PCB.</li>
<li>Avalon Interrupt Interface — an interface that allows components to signal events to other components.</li>
<li>Avalon Clock Interface — an interface that drives or receives clocks.</li>
<li>Avalon Reset Interface — an interface that provides reset connectivity.</li>
</ul>
<h2 id="projeto">Projeto<a class="headerlink" href="#projeto" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Vamos melhorar o projeto passado, faça uma cópia da pasta do projeto: <code>Lab2_FPGA_NIOS/</code> e renomeei para: <code>Lab3_FPGA_IP/</code>. Iremos agora trabalhar nessa nova pasta.</p>
</div>
<h3 id="criando-um-periferico">Criando um periférico<a class="headerlink" href="#criando-um-periferico" title="Permanent link">&para;</a></h3>
<p>Vamos criar um novo componente que será capaz de controlar os LEDs com maior autonomia. </p>
<p>Roteiro a ser seguido:</p>
<ol>
<li>Especificação</li>
<li>Gerar HDL que representa o periférico com interface Avalon</li>
<li>Criar o componente no Platform Designer <ul>
<li>Associar arquivos ao componente</li>
<li>Definições gerais</li>
<li>Associar as portas do componente com os sinais do barramento</li>
</ul>
</li>
<li>Usar componente no projeto</li>
<li>Criar driver (<code>.c</code> e <code>.h</code>)</li>
<li>Simular</li>
<li>Implementar/ Testar</li>
<li>Rever especificação (1.)</li>
</ol>
<p>Primeiramente precisamos definir o papel principal desse periférico e seu fluxo de dados. Com isso será possível definir se o periférico é do tipo: <strong>Master</strong> ou <strong>Slave</strong> e se sua interface é do tipo <strong>Memory Mapped</strong> ou <strong>Streaming</strong>.</p>
<p>Um periférico pode possuir mais de uma interface, por exemplo: Um periférico que irá processar um áudio em tempo real pode ter até três interfaces: O mesmo irá receber o áudio via a interface <strong>streaming</strong> e retornar o dado por outra interface de <strong>streaming</strong>, porém será necessária uma terceira interface para controle desse periférico, muito provavelmente do tipo <strong>Memory Mapped</strong>.</p>
<div class="admonition note">
<p>É possível transmitir pacotes de comando pela interface streaming, mas isso torna o projeto mais complexo.</p>
</div>
<p>O nosso simples periférico irá simplesmente receber configurações para acionar o LED, sem nenhum fluxo contínuo ou intenso de dados, sendo a interface mais apropriada a do <strong>periférico mapeado em memória</strong>. Além disso, nosso periférico exclusivo para controle do LED é um <strong>slave</strong> do sistema, já que ele deve ser controlado por outra parte do sistema (no nosso caso o uC) para agir conforme necessário.</p>
<h4 id="avalon-slave-memory-mapped">Avalon Slave Memory Mapped<a class="headerlink" href="#avalon-slave-memory-mapped" title="Permanent link">&para;</a></h4>
<p>Para nosso periférico se comunicar com o processador precisamos implementar o padrão de comunicação utilizado pelo NIOS. Podemos optar por implementar o padrão completo ou apenas uma parte de sua especificação. Por exemplo, se nosso periférico não faz uso do <code>waitrequest</code> ou <code>byteenable</code> podemos optar por não implementar esses sinais.</p>
<p>A seguir um exemplo dos sinais de um periférico mapeado em memória que possui como interface com o <code>Avalon-MM-Slave</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">entity</span> <span class="nc">peripheral_MM</span> <span class="k">is</span>
    <span class="k">port</span> <span class="p">(</span>
        <span class="c1">-- Gloabals</span>
        <span class="n">clk</span>                <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic</span>                     <span class="o">:=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>             
        <span class="n">reset</span>              <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic</span>                     <span class="o">:=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>             

        <span class="c1">-- Avalon Memmory Mapped Slave</span>
        <span class="n">avs_address</span>     <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">3</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">:=</span> <span class="p">(</span><span class="k">others</span> <span class="o">=&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span> 
        <span class="n">avs_read</span>        <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic</span>                     <span class="o">:=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>             
        <span class="n">avs_readdata</span>    <span class="o">:</span> <span class="k">out</span> <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:=</span> <span class="p">(</span><span class="k">others</span> <span class="o">=&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span> 
        <span class="n">avs_write</span>       <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic</span>                     <span class="o">:=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>           
        <span class="n">avs_writedata</span>   <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:=</span> <span class="p">(</span><span class="k">others</span> <span class="o">=&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>  
    <span class="p">);</span>
<span class="k">end</span> <span class="k">entity</span> <span class="nc">peripheral_MM</span><span class="p">;</span>
</code></pre></div>

<p>Note que a primeira parte do componente define um sinal de clock (<code>clk</code>) e um sinal de reset (<code>reset</code>), lembre que projetos digitais em FPGA devem ser na maioria das vezes síncronos. A segunda parte é a definição dos sinais que irão ser conectados no barramento para acesso de outros periféricos.</p>
<p>Lembrem que estamos criando um componente mapeado em memória, logo o mesmo deve ter comportamento e interface similar ao de uma memória. </p>
<ul>
<li><code>avs_address</code>: Endereço de acesso ao componente, no caso, 4 bits.</li>
<li><code>avs_read</code>: Indica que é um acesso de leitura</li>
<li><code>avs_readdata</code>: Dado que será retornado ao Master dado um acesso de leitura.</li>
<li><code>avs_write</code>: Indica que é um acesso de escrita</li>
<li><code>avs_writedata</code>: Dado que é transmitido ao componente dado um acesso de escrita.</li>
</ul>
<p>O tamanho da palavra do <code>avs_readdata</code> e do <code>avs_writadata</code> é definido pelo componente e não é fixo em 32 bits como no exemplo, pode assumir outros valores.</p>
<p>Uma escrita ao periférico é dada da seguinte forma:</p>
<ol>
<li>Master endereça periférico </li>
<li>Endereço absoluto é traduzido em relativo<ul>
<li>O endereço que o master escreve no periférico é composto por: <strong>addr</strong> <img alt="➕" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/2795.svg" title=":heavy_plus_sign:" /> <strong>offset</strong> porém o slave só possui acesso ao <strong>offset</strong>. </li>
</ul>
</li>
<li>Periférico recebe: <code>avs_address</code>, <code>avs_write = '1'</code> e <code>avs_writedata</code>.</li>
</ol>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Aavalon.png" /></p>
<p>Uma leitura ao periférico é dada da seguinte forma:</p>
<ol>
<li>Master endereça periférico </li>
<li>Endereço absoluto é traduzido em relativo</li>
<li>Periférico recebe: <code>avs_adddress</code> e <code>avs_read = '1'</code></li>
<li>Periférico atualiza: <code>avs_readdata</code></li>
</ol>
<div class="admonition question">
<p class="admonition-title">Perguntas</p>
<p>O barramento <code>AVALON</code> define outros sinais, responda a seguir sobre alguns desses sinais:</p>
<ul>
<li>waitrequest</li>
<li>Qual o papel do waitrequest? </li>
<li>Quem aciona o waitrequest (Slave ou Master)?</li>
<li>byteenable</li>
<li>Qual o papel do byteenable? </li>
<li>Quem aciona o byteenable (Slave ou Master)?</li>
</ul>
</div>
<h3 id="especificacao">Especificação<a class="headerlink" href="#especificacao" title="Permanent link">&para;</a></h3>
<p>Nosso periférico será no começo bem simples, apenas para entendermos todo o processo de desenvolvimento de um periférico e o seu uso. O periférico que iremos desenvolver será um substituto ao periférico PIO fornecido pela Intel-FPGA, utilizado no projeto do pisca LED com o NIOS.</p>
<p>Nosso periférico será mapeado em memória e possuirá um conduit (saída) onde será realizada o acionamento dos LEDs:</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Adiagram.png" /></p>
<p>O acesso ao nosso periférico será por uma palavra de 32 bits (para mater um padrão com o NIOS) e  terá dois registradores <code>REG_CONFIG</code> e <code>REG_DATA</code>:</p>
<ul>
<li><code>REG_CONIFG</code>: Registrador que controla o periférico, no nosso caso, irá ter somente um bit de: <code>Enable</code>/<code>Disable</code> (<code>bit0</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" />  <code>Enable/Disable</code>)</li>
<li><code>REG_DATA</code>: Registrador que possui o valor de cada LED (<code>bit0</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>LED0</code>; <code>bit1</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>LED1</code> ....).</li>
</ul>
<h3 id="gerar-hdl-que-representa-o-periferico-com-interface-avalon">Gerar HDL que representa o periférico com interface Avalon<a class="headerlink" href="#gerar-hdl-que-representa-o-periferico-com-interface-avalon" title="Permanent link">&para;</a></h3>
<p>Partindo da entidade fornecida (<code>peripheral_MM</code>), podemos criar um componente que implementa parcialmente a especificação anterior, nessa implementação não temos os dois registradores (<code>REG_CONFIG</code> e <code>REG_DATA</code>), temos apenas a funcionalidade do <code>REG_DATA</code>. Note que a implementação faz uso de um generic para definir a quantidade de LEDs que esse periférico controla. Esse genérico poderá ser configurado pela interface gráfica do Plataform Designer, tornando um componente customizado.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Crie um arquivo chamado: <code>peripheral_LED.vhd</code> e salve na pasta do projeto : <code>Lab3_FPGA_IP/IP/</code></p>
<div class="admonition warning">
<p>Será necessário criar a pasta IP</p>
</div>
</div>
<div class="highlight"><pre><span></span><code><span class="k">library</span> <span class="nn">IEEE</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IEEE.std_logic_1164.</span><span class="k">all</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IEEE.std_logic_unsigned.</span><span class="k">all</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">IEEE.numeric_std.</span><span class="k">all</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">work.</span><span class="k">all</span><span class="p">;</span>

<span class="k">entity</span> <span class="nc">peripheral_LED</span> <span class="k">is</span>
    <span class="k">generic</span> <span class="p">(</span>
        <span class="n">LEN</span>  <span class="o">:</span> <span class="kt">natural</span> <span class="o">:=</span> <span class="mi">4</span>
    <span class="p">);</span>
    <span class="k">port</span> <span class="p">(</span>
        <span class="c1">-- Gloabals</span>
        <span class="n">clk</span>                <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic</span>                     <span class="o">:=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>             
        <span class="n">reset</span>              <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic</span>                     <span class="o">:=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>             

        <span class="c1">-- I/Os</span>
        <span class="n">LEDs</span>               <span class="o">:</span> <span class="k">out</span> <span class="kt">std_logic_vector</span><span class="p">(</span><span class="n">LEN</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:=</span> <span class="p">(</span><span class="k">others</span> <span class="o">=&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>

        <span class="c1">-- Avalion Memmory Mapped Slave</span>
        <span class="n">avs_address</span>     <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">3</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">:=</span> <span class="p">(</span><span class="k">others</span> <span class="o">=&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span> 
        <span class="n">avs_read</span>        <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic</span>                     <span class="o">:=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>             
        <span class="n">avs_readdata</span>    <span class="o">:</span> <span class="k">out</span> <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:=</span> <span class="p">(</span><span class="k">others</span> <span class="o">=&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span> 
        <span class="n">avs_write</span>       <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic</span>                     <span class="o">:=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>             
        <span class="n">avs_writedata</span>   <span class="o">:</span> <span class="k">in</span>  <span class="kt">std_logic_vector</span><span class="p">(</span><span class="mi">31</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:=</span> <span class="p">(</span><span class="k">others</span> <span class="o">=&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
    <span class="p">);</span>
<span class="k">end</span> <span class="k">entity</span> <span class="nc">peripheral_LED</span><span class="p">;</span>

<span class="k">architecture</span> <span class="nc">rtl</span> <span class="k">of</span> <span class="nc">peripheral_LED</span> <span class="k">is</span>
<span class="k">begin</span>

  <span class="k">process</span><span class="p">(</span><span class="n">clk</span><span class="p">)</span>
  <span class="k">begin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">)</span> <span class="k">then</span>
      <span class="n">LEDs</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="k">others</span> <span class="o">=&gt;</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
    <span class="k">elsif</span><span class="p">(</span><span class="n">rising_edge</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="k">then</span>
        <span class="k">if</span><span class="p">(</span><span class="n">avs_address</span> <span class="o">=</span> <span class="s">&quot;0001&quot;</span><span class="p">)</span> <span class="k">then</span>                  <span class="c1">-- REG_DATA</span>
            <span class="k">if</span><span class="p">(</span><span class="n">avs_write</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">)</span> <span class="k">then</span>
              <span class="n">LEDs</span> <span class="o">&lt;=</span> <span class="n">avs_writedata</span><span class="p">(</span><span class="n">LEN</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">downto</span> <span class="mi">0</span><span class="p">);</span>
            <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
        <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
  <span class="k">end</span> <span class="k">process</span><span class="p">;</span>

<span class="k">end</span> <span class="nc">rtl</span><span class="p">;</span>
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Limitações dessa implementação</p>
<ul>
<li>Não possui um registrador de configuração: <code>REG_CONFIG</code></li>
<li>Não é possível ler: <code>REG_DATA</code> via barramento <strong>Avalon</strong> </li>
<li>impede a aplicação de máscaras!</li>
</ul>
</div>
<p>Poderíamos já nessa etapa testar o componente, criando um <code>testbench</code> para excitar o módulo e verificar seu comportamento. Grande parte do desenvolvimento de um projeto de hardware é gasto nos testes, que podem ser tão complexos quanto o próprio módulo. Vamos pular essa etapa aqui, iremos simular em um nível mais alto.</p>
<h3 id="configurando-path">Configurando path<a class="headerlink" href="#configurando-path" title="Permanent link">&para;</a></h3>
<p>Agora iremos adicionar o nosso periférico no <strong>Platform Designer</strong>, esse novo componente que será criado será incorporado na ferramenta, para isso:</p>
<p>Precisamos indicar para o PD o local que ele deve buscar para encontrar por códigos fonte que não fazem parte do catálogo padrão, para isso:</p>
<ol>
<li><code>Tools</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>Options</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>IP Search Path</code></li>
<li>Adicione a pasta <code>IP</code> recém criada.</li>
</ol>
<p>E agora remova o componente PIO:</p>
<ol>
<li>Remova o PIO que controlava os LEDs (agora iremos fazer o controle pelo nosso componente)</li>
</ol>
<h3 id="criando-componente">Criando componente<a class="headerlink" href="#criando-componente" title="Permanent link">&para;</a></h3>
<p>Só adicionar o arquivo HDL (<code>.vhd</code> ou <code>.v</code>) não é suficiente para o PD reconhecer o componente, precisamos criar um segundo arquivo (<code>*_hw.tcl</code>) que é lido pelo PD, esse arquivo possuirá todas as configurações e descrições do novo componente. Para isso:</p>
<ul>
<li><code>File</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>New Component</code> <img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /></li>
</ul>
<p>E uma interface gráfica de configuração do componente será exibida. A primeira parte é referente a descrição do próprio componente. De o nome desse componente de : <code>peripheral_LED</code> e preencha sua descrição.</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Ainfo.png" /></p>
<p>Já na aba <code>Files</code> temos as informações de quais arquivos pertencem ao componente. </p>
<h4 id="files">Files<a class="headerlink" href="#files" title="Permanent link">&para;</a></h4>
<p>Na aba Files adicione o arquivo <code>peripheral_LED.vhd</code>:</p>
<ol>
<li><code>Files</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>Syntesis Files</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>add file</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <strong><code>peripheral_LED.vhd</code></strong></li>
<li>Clique em <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>Analyze Synthesis Files</code> : isso fará com que a ferramenta faça uma breve análise dos arquivos HDL e detecte as interfaces do componente.</li>
</ol>
<p>Note o atributo do arquivo: <code>Top-level File</code>, isso indica que o <code>peripheral_LED.vhd</code> é o arquivo principal desse componente, se tivéssemos um desenvolvimento hierárquico do componente, nessa etapa adicionaríamos vários arquivos e deveríamos configurar qual deles é o toplevel.</p>
<ul>
<li>Na secção <code>VHDL Simulation Files</code>  <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <strong>Copy from Synthesis Files</strong> <img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /></li>
</ul>
<p>Note que se não adicionarmos esse arquivo nessa secção, na hora de simular o projeto o componente estaria vazio. Porquê o padrão não é o de automaticamente copiar os arquivos da síntese para a simulação? Pois nem sempre conseguimos simular o que será sintetizado. Pense no caso desse componente ser um controlador de memória, se formos simular não teremos a memória física para o controlador acessar e a simulação não funcionará. Uma solução seria de ter dois componentes, um para simulação (que imita a memória) e outro para síntese.</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Afiles.png" /></p>
<h4 id="signals-interfaces">Signals &amp; Interfaces<a class="headerlink" href="#signals-interfaces" title="Permanent link">&para;</a></h4>
<p>Nessa secção iremos configurar as interfaces do nosso componente, e como o PD irá interpretá-las quando formos conectar ao resto do sistema. Note que algumas interfaces já foram detectadas pelo PD, porém temos um erro que será corrigido.</p>
<p>Nas interfaces padrões note que o <code>Component Editor</code> já detectou uma interface: </p>
<ul>
<li><strong>avalon_slave_0</strong></li>
<li><strong>clock</strong></li>
<li><strong>reset</strong></li>
</ul>
<p>Isso aconteceu pelos nomes da entidade do <code>peripheral_led</code>.</p>
<p>Vamos primeiramente editar o <code>avalon_slave_0</code>. Clique na interface e note que a ferramenta indica um erro : </p>
<div class="admonition failure">
<p class="admonition-title">Failure</p>
<div class="highlight"><pre><span></span><code>Error: avalon_slave_0_1: Interface must have an associated reset
</code></pre></div>

</div>
<p>Vamos associar ter que associar um sinal der reset a interface (parte sequência do IP), para isso :</p>
<ul>
<li><code>avalon_slave_0</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>Associated Reset</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>reset</code> <img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /></li>
</ul>
<p>Podemos notar ainda pelo diagrama (e pela mensagem de erro) que a ferramenta interpretou de forma errada o nosso sinal <code>LEDs</code>, pertencente a entidade do componente: </p>
<div class="highlight"><pre><span></span><code>-- I/Os
LEDs : out std_logic_vector(LEN - 1 downto 0) := (others =&gt; &#39;0&#39;);
</code></pre></div>

<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Acomponent.png" /></p>
<p>Note pelo diagrama de blocos que o PD atribui essa saída como sendo parte do barramento Avalon: <strong>writerequestvalid_n</strong>, o que não é verdade. Para corrigir isso, precisamos de uma nova aba que não é padrão de exibição, no <code>component builder</code> clique em:</p>
<ul>
<li><strong>Component builder</strong> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>View</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>Signals</code> <img alt="🆗" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f197.svg" title=":ok:" /></li>
</ul>
<p>Essa nova aba permite verificarmos (e associarmos) as entradas e saídas da entidade (toplevel) com sinais e tipos de sinais definido pelo PD.</p>
<p>Iremos indicar agora para a ferramenta que o sinal <code>LEDs</code> deve ser interpretado como um <code>conduite</code>, edite os sinais como na figura a seguir :</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Aconduit.png" /></p>
<h4 id="finalizando">Finalizando<a class="headerlink" href="#finalizando" title="Permanent link">&para;</a></h4>
<p>Verifique os sinais e o diagrama de bloco antes de continuar e clique em <strong>Finish</strong>. Quando o componente for gerado, ele automaticamente irá aparecer no catálogo de componentes que podem ser inseridos no SoC:</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Acatalogo.png" /></p>
<p>Porém o arquivo de configuração desse componente (.tcl) foi salvo na pasta raiz do projeto do Quartus: </p>
<ul>
<li><code>Lab3_FPGA_IP/peripheral_LED_hw.tcl</code></li>
</ul>
<p>Esse arquivo <code>.tcl</code> descreve todas as configurações realizadas anteriormente no componente. O mais natural é que esse arquivo esteja na mesma localidade (pasta IP) que os códigos HDL. Mova essa arquivo para:</p>
<ul>
<li><code>Lab3_FPGA_IP/IP/peripheral_LED_hw.tcl</code></li>
</ul>
<p>Agora precisamos editar o arquivo <code>.tcl</code> para atualizarmos o local do arquivo <code>peripheral_LED.vhd</code>, procure pela secção <strong>files set</strong>:</p>
<ul>
<li>Antes </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nv">add_fileset_file</span> peripheral_LED.vhd VHDL PATH IP<span class="o">/</span>peripheral_LED.vhd TOP_LEVEL_FILE
<span class="nv">...</span>
<span class="nv">add_fileset_file</span> peripheral_LED.vhd VHDL PATH IP<span class="o">/</span>peripheral_LED.vhd
</code></pre></div>

<p>E edite para:</p>
<div class="highlight"><pre><span></span><code><span class="nv">add_fileset_file</span> peripheral_LED.vhd VHDL PATH peripheral_LED.vhd TOP_LEVEL_FILE
<span class="nv">...</span>
<span class="nv">add_fileset_file</span> peripheral_LED.vhd VHDL PATH peripheral_LED.vhd
</code></pre></div>

<h3 id="utilizando-o-componente-no-pd">Utilizando o componente no PD<a class="headerlink" href="#utilizando-o-componente-no-pd" title="Permanent link">&para;</a></h3>
<p>Agora adicione o componente no projeto e faça as conexões corretas (como se fosse outro componente), exporte o sinal dos LEDs, o resultado final deve ser algo como:</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Afinal.png" /></p>
<p>Gere o componente: Clique em <code>Generate HDL</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>Generate</code>. </p>
<div class="admonition warning">
<p>Marque a opção: ✅ <code>Create a Simulation Model</code></p>
</div>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Agen.png" /></p>
<h3 id="utilizando-o-componente-no-toplevelvhd">Utilizando o componente no <code>topLevel.vhd</code><a class="headerlink" href="#utilizando-o-componente-no-toplevelvhd" title="Permanent link">&para;</a></h3>
<p>Precisamos agora modificar o componente inserido no topLevel, para isso no PD gere novamente o template de utilização :</p>
<ul>
<li>No Platform Designer: <code>Generate</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" />  <code>Show Instatiation Template</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>VHDL</code></li>
</ul>
<p>No meu caso o resultado foi:</p>
<div class="highlight"><pre><span></span><code>    component niosHello is
        port (
            buts_export   : in  std_logic_vector(2 downto 0) := (others =&gt; &#39;X&#39;); -- export
            clk_clk       : in  std_logic                    := &#39;X&#39;;             -- clk
            reset_reset_n : in  std_logic                    := &#39;X&#39;;             -- reset_n
            leds_name     : out std_logic_vector(3 downto 0)                     -- name
        );
    end component niosHello;

    u0 : component niosHello
        port map (
            buts_export   =&gt; CONNECTED_TO_buts_export,   --  buts.export
            clk_clk       =&gt; CONNECTED_TO_clk_clk,       --   clk.clk
            reset_reset_n =&gt; CONNECTED_TO_reset_reset_n, -- reset.reset_n
            leds_name     =&gt; CONNECTED_TO_leds_name      --  leds.name
        );
</code></pre></div>

<p>Devemos inserir agora esse componente com a nova interface (<strong>leds_name</strong>) no <code>Lab3_FPGA_IP.vhd</code>.</p>
<blockquote>
<p>Você deve fazer essa etapa com cuidado. Esses nomes podem alterar entre versões da ferramenta.</p>
</blockquote>
<p>Editando o <code>Lab3_FPGA_IP.vhd</code>:</p>
<div class="admonition success">
<p class="admonition-title">Recompile</p>
<p>Salve, compile o projeto e programe a FPGA</p>
</div>
<p>Podemos analisar agora o RTL do projeto e mais especificamente o do componente criado:</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Artl.png" /></p>
<p>Verificamos que a ferramenta inferiu um registrador de 4 bits para armazenar o valor dos LEDs, um Mux para indicar se os registradores serão ou não atualizados com um novo valor e um comparador para verificar se o endereço é equivalente a <code>0x01</code>.</p>
<h2 id="firmware">Firmware<a class="headerlink" href="#firmware" title="Permanent link">&para;</a></h2>
<p>Devemos agora escrever um firmware que será executado no NIOS e que acesse e controle nosso periférico. Para isso será necessário criarmos um BSP para o projeto. Abra o <strong>NIOS II Software Build ...</strong> e refaça a etapa do tutorial anterior com o novo SoC e adicione o código a seguir:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;system.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;alt_types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;io.h&gt; /* Leiutura e escrita no Avalon */</span><span class="cp"></span>

<span class="c1">//#define SIM</span>

<span class="c1">// LED Peripheral</span>
<span class="cp">#define REG_DATA_OFFSET 1</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">p_led</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">PERIPHERAL_LED_0_BASE</span><span class="p">;</span>

<span class="cp">#ifndef SIM</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Embarcados++ </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">led</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">){</span>
          <span class="o">*</span><span class="p">(</span><span class="n">p_led</span><span class="o">+</span><span class="n">REG_DATA_OFFSET</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">led</span><span class="o">++</span><span class="p">);</span>
<span class="cp">#ifndef SIM</span>
          <span class="n">usleep</span><span class="p">(</span><span class="mi">500000</span><span class="p">);</span> <span class="c1">// remover durante a simulação</span>
<span class="cp">#endif</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
          <span class="n">led</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>O firmware utiliza o <code>peripheral_LED</code> para controlar os LEDs da placa, note que o acesso dessa vez é feito pelo ponteiro <code>p_led</code> e não mais pela função da Alteara <code>IOWR_32DIRECT</code> (deveria funcionar também).</p>
<h3 id="executando">Executando<a class="headerlink" href="#executando" title="Permanent link">&para;</a></h3>
<p>Execute o firmware no kit de desenvolvimento e verifique se sua funcionalidade está correta. Lembre que o HW já deve estar programado (via quartus), caso contrário não funcionará.</p>
<h2 id="simulando">Simulando<a class="headerlink" href="#simulando" title="Permanent link">&para;</a></h2>
<p>Uma das grandes vantagens de trabalharmos com SoftProcessor é que temos acesso ao seu código fonte (criptografado ou não) e isso possibilita que possamos simular todo o sistema, verificando suas funcionalidades internas, comunicação da CPU com os periféricos, interface do firmware com o resto do sistema. Vamos nessa etapa simular a interface do NIOS com o nosso periférico e verificar se está tudo certo.</p>
<p>Note que no código anterior, o printf foi comentando, assim como o delay de 50000 us, que no lugar foi inserido um de 1us. Isso foi feito para acelerar a simulação e verificarmos mais rapidamente o acesso do NIOS ao periférico, que acontece na linha :</p>
<div class="highlight"><pre><span></span><code>    <span class="o">*</span><span class="p">(</span><span class="n">p_led</span><span class="o">+</span><span class="n">REG_DATA_OFFSET</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">led</span><span class="o">++</span><span class="p">);</span>
</code></pre></div>

<p>Nesse momento, o NIOS envia um comando ao barramento no endereço <strong>PERIPHERAL_LED_0_BASE + REG_DATA_OFFSET</strong>, o comando carrega a mensagem: <strong>0x01 &lt;&lt; led</strong>, gravando no registrador <code>REG_DATA</code> qual LED deve ser acionado.</p>
<h3 id="configurando-o-bsp">Configurando o bsp<a class="headerlink" href="#configurando-o-bsp" title="Permanent link">&para;</a></h3>
<p>Para obtermos um resultado mais rápido é possível ativarmos uma opção no bsp chamada de: <strong>enable_sim_opitimize</strong>. Quando ativada, o binário compilado só poderá ser usado para simulação, <strong>não pode ser embarcado no HW!</strong>. Com essa opção temos um ganho significativo no tempo de execução do modelo no modelsim.</p>
<p>Além de configurarmos a otimização durante a simulação, iremos desativar o <strong>stdin, stdout, stderr</strong> para a simulação ficar ainda mais rápida, caso contrário teremos que esperar por muito tempo até verificarmos o resultado do código. Note que a simulação abrange todo o HW desde o processador até o barramento e periféricos.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Para simularmos 1 ms de execução do HW será necessário muito mais que 1 ms de esforço computacional! O tempo pode chegar a unidades de hora!!</p>
</div>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Asim.png" /></p>
<h3 id="modelsim">ModelSim<a class="headerlink" href="#modelsim" title="Permanent link">&para;</a></h3>
<p>No <strong>Eclipse</strong>, após ter compilado o projeto:</p>
<ul>
<li><code>Run</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>Run configuration</code> <img alt="➡️" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/27a1.svg" title=":arrow_right:" /> <code>Nios II ModelSim</code></li>
</ul>
<p>O simulador a ser utilizado é o modelsim da Mentor, o mais completo do mercado e fornecido com algumas customizações pela Intel-FPGA. No modelsim, iremos adicionar os sinais que desejamos visualizar, para isso, siga o que indica a figura a seguir:</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Amodelsim1.png" /></p>
<p>Após adicionar todos os sinais que fazem parte do periférico <code>led_peripheral</code> iremos executar 500 us de simulação:</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Amodelsim2.png" /></p>
<p>Após a simulação finalizar, note os valore dos sinais <code>avs_write</code>, <code>avs_writedata</code>, <code>avs_LEDs</code> e como eles mudam no tempo em respeito ao que foi feito no código.</p>
<p><img alt="" src="../figs/Tutorial-FPGA-IP%3Amodelsim3.png" /></p>
<h2 id="entrega-3">Entrega 3<a class="headerlink" href="#entrega-3" title="Permanent link">&para;</a></h2>
<p>Siga para a terceira entrega:</p>
<ul>
<li><a href="/Entrega-3">Entega 3</a></li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../Entrega-2/" title="👁 Entrega 2" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                👁 Entrega 2
              </div>
            </div>
          </a>
        
        
          <a href="../Entrega-3/" title="👁 Entrega 3" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                👁 Entrega 3
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 / Prof. Rafael Corsi / rafael.corsi@insper.edu.br
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.df0def68.min.js"></script>
      <script src="../assets/javascripts/bundle.ba57d267.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ["instant", "navigation.expand", {"tabs": true}],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../js/progress.js"></script>
      
    
  </body>
</html>